---
title: "Example usage of the scrunchy package"
author: "Kent Riemondy"
date: "`r Sys.Date()`"
output: radix::radix_article
vignette: >
  %\VignetteIndexEntry{Basic Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```

# Install the package

```{r install, eval = FALSE}
devtools::install_github("hesselberthlab/scrunchy")
```

# Create a Functional Cell Experiment (fce) object

```{r create_fce}
suppressMessages(library(scrunchy))
suppressMessages(library(SingleCellExperiment))

# load mRNA UMI data
mrna <- scrunchy:::load_csv(scrunchy:::scrunchy_data("mrna.csv.gz"))
mrna[1:5, 1:5]

# load haircut UMI data
hcut <- scrunchy:::load_csv(scrunchy:::scrunchy_data("haircut.csv.gz"))
hcut[1:5, 1:5]


fce <- create_fce(mrna, hcut)
```

`fce` is an object of class MultiAssayExperiment, which can contain data from multiple modalities, and
importantly does not require that each modality has the same number of cells or features. 

```{r}
# sce stores RNA info
fce[["sce"]]
counts(fce[["sce"]])[1:5, 1:5]

# fsce stores functional data
fce[["fsce"]]
counts(fce[["fsce"]])[1:5, 1:5]

# row annotations contain info about each row in the matrix
rowData(fce[["fsce"]])

# column annotations contain info about each row in the matrix, 
# or about each unique cell present in any of the experiments
colData(fce)
```

# Plots

`plot_hairpin` produces a coverage plot across each hairpin in the data.

```{r hairpin_plot}
plot_hairpin(fce)
```

Specific adduct positions can be highlighted by including this information in the `fce` object.

```{r hairpin_w_adduct_pos}
# add in adduct information when building fce object
adducts <- data.frame(hairpin = c("Uracil", "riboG"),
                      adduct_position1 = c(1, 10),
                      adduct_position2 = c(10, 50),
                      stringsAsFactors = FALSE)

fce <- create_fce(mrna, hcut, adduct_positions = adducts)

rowData(fce[["fsce"]])

plot_hairpin(fce)
```

```{r}
## subset which cells are used for plots
plot_hairpin(fce,
             cells_to_plot = sample(colnames(fce[["fsce"]]), 1))
```

# Normalize

RNA data is log normalized and scaled to total UMI count for each cell. Functional data is normalized using the center log ratio method used for CITE-Seq analysis.

Normalized data is stored in the `logcounts` slot of each `SingleCellExperiment` object.

```{r}
# normalize rna and functional data
fce <- normalize_fce(fce)

logcounts(fce[["fsce"]])[1:5, 1:3]
```

